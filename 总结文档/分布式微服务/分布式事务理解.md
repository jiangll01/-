 

![640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1](https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGq4XeN4M2oYfHjH52bw8XJ66zSck1ictTSVjHL24A8V19Ie2Ibxlxbk8WzEn72njyazJrkfF9iauDlw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1)

 

 

![640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1](https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGq4XeN4M2oYfHjH52bw8XJ6FIhriaxzciaCSB3uF9k9BbJ1PYNkRbXjiaP9dtzNWvWpVqxMIJ03nFUBg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1)

 

 

**————— 第二天 —————**

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGoEEbyKibrkPzDQenPzxOZyibwhEkMMbG9Veaa5ttlLZN6IFqHhn7BgP4zZ15G6gjS5vMzeI41AW5jA/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGoEEbyKibrkPzDQenPzxOZyibaK017ibPvJkRp3m78YJwWofI4qoChpgAIY7sdpCcx78guVwhxrQVkIg/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpTNyU3BCz6asl3rjicBs7dIaNOM5AhphNrgHEicbvNdWt1EGjrLKWwmhXOW1hBVBVJ6B4a6TYEYUUA/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpTNyU3BCz6asl3rjicBs7dIhuLaukDxo3uS3X967o6cUCYvia18LRGC3oZQI6zf7WiceoKT122dic0xg/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpTNyU3BCz6asl3rjicBs7dIUqgd7Zicbwaf3lXwRPCBUY2NKmYKgE1BIcsAkOSUkb8KlGfZfCbvaXw/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpTNyU3BCz6asl3rjicBs7dIWFiaTfGD51Iic84IZDJO7nCicLRIaX7mUoAh7O2qhHppq0I3xxVXFV9kQ/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpTNyU3BCz6asl3rjicBs7dIHStQTuZEySiaFTe1qGYNnyP7XFAjLCA9EicmzUKNt00icUDgcIScSxuww/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpTNyU3BCz6asl3rjicBs7dIhApKnXKqPZyib5DJyMJYbhqIjcNxOtYricldIVMIkgHhbwM5dLdsJBXA/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpTNyU3BCz6asl3rjicBs7dIcz1KF7zoj8ibO9wBmPrqwRKjX5NpWtB4Nr4epoqibrB0CMItaKGicj7uw/640?wx_fmt=jpeg)

 

 

————————————

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGqFoxMMKMF99uD8UgT9wfpLDZYibB6ekN5xLYO3uibNj3crxgNX6j62NVDMJjQcicvZRKMZ4uSI6Y0zg/640?wx_fmt=jpeg)

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGqFoxMMKMF99uD8UgT9wfpLyh8p0xCyccZDujw1vYlpHuTJfnEervloLV6jzknIEhiaWLUNFg1bhMQ/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGpTNyU3BCz6asl3rjicBs7dIrwdwz7LpJuYx5xV0GWlibcfvpqXg0OWyI8mGv5krwn0dEv5UrM9o1uA/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGoVriblFibw1qZkk3l6QnypXmhcn44xaKT8WhpibfAARY9Gzn59NlibqenXA2ibibDHn10AvCVMpaksLf2w/640?wx_fmt=jpeg)

 

 

**假如没有分布式事务**

 

在一系列微服务系统当中，假如不存在分布式事务，会发生什么呢？让我们以互联网中常用的交易业务为例子：

 

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp5gfMpBib3Vm2IsPAICBYZCpyRYV1X8KXicVPKibeyjfqMUZzpFCkC6GXM528Kic56xliagulfmuUANzQ/640?wx_fmt=png)

 

 

上图中包含了库存和订单两个独立的微服务，每个微服务维护了自己的数据库。在交易系统的业务逻辑中，一个商品在下单之前需要先调用库存服务，进行扣除库存，再调用订单服务，创建订单记录。

 

正常情况下，两个数据库各自更新成功，两边数据维持着一致性。

 

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp5gfMpBib3Vm2IsPAICBYZCJ9n7WP2dVhskCIpB7J2I9OWII0YDDfOC62W205W6xHglkGFLWmDHhg/640?wx_fmt=png)

 

 

但是，在非正常情况下，有可能库存的扣减完成了，随后的订单记录却因为某些原因插入失败。这个时候，两边数据就失去了应有的一致性。

 

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp5gfMpBib3Vm2IsPAICBYZCf0tkbqJsM1iakUQFYy48KWWvUovlAb4G1UgGaD8LMhxwViaxGPckWVzg/640?wx_fmt=png)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGqdzlOV0Nf6rU8eDDNSwBgsQ02BpRozcpM2lrmTRGwnfE8YIYhYicqpjSbOm3LXtic55jBdAtcnmovw/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGqdzlOV0Nf6rU8eDDNSwBgssBwZicXic0A2l1aYchQ65hXS7ubN9vp1wnyVTTibDERHdSJB1RWX1bV9Q/640?wx_fmt=jpeg)

 

 

**什么是分布式事务？**

 

分布式事务用于在分布式系统中保证不同节点之间的数据一致性。分布式事务的实现有很多种，最具有代表性的是由**Oracle Tuxedo**系统提出的**XA**分布式事务协议。

 

XA协议包含**两阶段提交（2PC）**和**三阶段提交（3PC）**两种实现，这里我们重点介绍两阶段提交的具体过程。

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofsfN7BkUDr9E3iaPTtgJf0rIgJ0a0akohGLZvOASXQHmeHUE2k34bOEA/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofPB9OiaDQbKKtNBIgj6DFl7jyBd6sIJoa4rq4l0DFaAUiaibzDicHNohGWg/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofyLmZNmibPWlbTcfSuiazjOxLQgawRRcia2coII8TpLh66YXG4QATpa1BQ/640?wx_fmt=jpeg)

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGrDmwB1vMOJdRmBObRI9E4lS8QMqFBzr9GSB22t819svyBoTg5SWSvP344qviaOOUGNjFPrOm7dmTQ/640?wx_fmt=jpeg)

 

 

在魔兽世界这款游戏中，副本组团打BOSS的时候，为了更方便队长与队员们之间的协作，队长可以发起一个“就位确认”的操作：

 

 

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofVRL815UNR3mnXpYf81U5Lv5WtNiamohdu792UPtCuHhNLkg7FGMvicFw/640?wx_fmt=png)

 

 

当队员收到就位确认提示后，如果已经就位，就选择“是”，如果还没就位，就选择“否”。

 

 

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofqPopLXT6ALzBz6elibzNxT8XoQSaEgXdJjYuRbkKV65HtVDLFibeWvVw/640?wx_fmt=png)

 

 

当队长收到了所有人的就位确认，就会向所有队员们发布消息，告诉他们开始打BOSS。

 

 

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofgsicDP1lt3zSlNj0DNgFaf1o5F0uOn6oJd5sngZzqZy01ZVXBBcSQ4Q/640?wx_fmt=png)

 

 

相应的，在队长发起就位确认的时候，有可能某些队员还并没有就位：

 

 

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofVRL815UNR3mnXpYf81U5Lv5WtNiamohdu792UPtCuHhNLkg7FGMvicFw/640?wx_fmt=png)

 

 

 

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofYaNSnxNnZfsXwxhdicfIrx0bD8BY5GiaVBqxphFcdsuJgrdPX1iaetuOg/640?wx_fmt=png)

 

 

 

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofqxmWafL4tcIcMFcHhAcR1AX3QvS9Fw5JCC0dPTOYvtlUSJic4uibuZHg/640?wx_fmt=png)

 

 

 

以上就是魔兽世界当中组团打BOSS的确认流程。这个流程和XA分布式事务协议的两阶段提交非常相似。

 

那么XA协议究竟是什么样子呢？在XA协议中包含着两个角色：**事务协调者**和**事务参与者**。让我们来看一看他们之间的交互流程：

 

**第一阶段：**

 

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofektAk1LqqTkgjlFicuYE55XHon5yUguGBSk97Ec7vY62wTibVia7iaTNvg/640?wx_fmt=png)

 

 

在XA分布式事务的第一阶段，作为事务协调者的节点会首先向所有的参与者节点发送Prepare请求。

 

在接到Prepare请求之后，每一个参与者节点会各自执行与事务有关的数据更新，写入Undo Log和Redo Log。如果参与者执行成功，暂时不提交事务，而是向事务协调节点返回“完成”消息。

 

当事务协调者接到了所有参与者的返回消息，整个分布式事务将会进入第二阶段。

 

 

**第二阶段：**

 

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqof9zeDNDYh1qjyYTo9ib4wVCu2KrtqIyJBffhkAvLNybmibEMiaSoKGqFKg/640?wx_fmt=png)

 

 

在XA分布式事务的第二阶段，如果事务协调节点在之前所收到都是正向返回，那么它将会向所有事务参与者发出Commit请求。

 

接到Commit请求之后，事务参与者节点会各自进行本地的事务提交，并释放锁资源。当本地事务完成提交后，将会向事务协调者返回“完成”消息。

 

当事务协调者接收到所有事务参与者的“完成”反馈，整个分布式事务完成。

 

 

以上所描述的是XA两阶段提交的正向流程，接下来我们看一看失败情况的处理流程：

 

 

**第一阶段：**

 

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofr3Qjn25OskkZ0Hd1ibMicWpQgTJShGSyAsthibicgNeZHUOx5Sy2Mlwsrw/640?wx_fmt=png)

 

 

 

**第二阶段：**

 

![640?wx_fmt=png](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofMklXcDS3cVJdWjw4vgibtBiaolQia9NMsT4ibMiaJyHPwwNjr9Db7ljEBug/640?wx_fmt=png)

 

 

 

在XA的第一阶段，如果某个事务参与者反馈失败消息，说明该节点的本地事务执行不成功，必须回滚。

 

于是在第二阶段，事务协调节点向所有的事务参与者发送Abort请求。接收到Abort请求之后，各个事务参与者节点需要在本地进行事务的回滚操作，回滚操作依照Undo Log来进行。

 

 

以上就是XA两阶段提交协议的详细过程。

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofm2k1wqqjaNlfE3Vm5uuqRs7rJKicqjibiaic4DOnjH7hTI81SIJvPcoQxA/640?wx_fmt=jpeg)

 

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGp2Ny2lbXKGqaNjy4cbhqofibHpA9K9pOXO1EK51CwarPFzColR1Nd6AN4PyyfexRqnia4gZf0mmmlA/640?wx_fmt=jpeg)

 

 

**XA两阶段提交的不足**

 

XA两阶段提交究竟有哪些不足呢？

 

**1.性能问题**

XA协议遵循强一致性。在事务执行过程中，各个节点占用着数据库资源，只有当所有节点准备完毕，事务协调者才会通知提交，参与者提交后释放资源。这样的过程有着非常明显的性能问题。

 

**2.协调者单点故障问题**

事务协调者是整个XA模型的核心，一旦事务协调者节点挂掉，参与者收不到提交或是回滚通知，参与者会一直处于中间状态无法完成事务。

 

**3.丢失消息导致的不一致问题。**

在XA协议的第二个阶段，如果发生局部网络问题，一部分事务参与者收到了提交消息，另一部分事务参与者没收到提交消息，那么就导致了节点之间数据的不一致。

 

 

如果避免XA两阶段提交的种种问题呢？有许多其他的分布式事务方案可供选择：

 

**1.XA三阶段提交**

XA三阶段提交在两阶段提交的基础上增加了CanCommit阶段，并且引入了超时机制。一旦事物参与者迟迟没有接到协调者的commit请求，会自动进行本地commit。这样有效解决了协调者单点故障的问题。但是性能问题和不一致的问题仍然没有根本解决。

 

**2.MQ事务**

利用消息中间件来异步完成事务的后一半更新，实现系统的最终一致性。这个方式避免了像XA协议那样的性能问题。

 

**3.TCC事务**

TCC事务是Try、Commit、Cancel三种指令的缩写，其逻辑模式类似于XA两阶段提交，但是实现方式是在代码层面来人为实现。

 

 

 

![640?wx_fmt=jpeg](https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/NtO5sialJZGrDmwB1vMOJdRmBObRI9E4lRHVDFbOOoeauWMptVdzgT0MxHib62p8Jl9AvmChvxzg6830bZZOoTsA/640?wx_fmt=jpeg)

 

 